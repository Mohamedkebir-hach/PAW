
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance System — Multi-Role Prototype</title>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== Theme variables ===== */
    :root{
      --accent:#2b6b8f;
      --accent-2:#7aa9c7;
      --bg:#f7f7f8;
      --card:#ffffff;
      --muted:#6b6b6b;
      --good:#dff6e9;
      --warn:#fff7d9;
      --bad:#ffdce0;
      --head:#174f67;
      --tick:#f3c13a;
      --radius:10px;
      --maxw:1180px;
    }

    /* ===== Reset & base ===== */
    *{box-sizing:border-box}
    body{
      font-family: Inter, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:#222;
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Header / Nav ===== */
    header{background:var(--accent); color:#fff; position:sticky; top:0; z-index:60; box-shadow:0 1px 0 rgba(0,0,0,0.06)}
    .nav{max-width:var(--maxw); margin:0 auto; display:flex; align-items:center; gap:12px; padding:10px 16px}
    .brand{font-weight:700; display:flex; align-items:center; gap:10px}
    .brand img{height:28px; display:block}
    .nav .spacer{flex:1}
    .nav a, .nav select{color:#fff; text-decoration:none; padding:8px 10px; border-radius:6px; font-weight:600; opacity:0.95; background:transparent; border:0}
    .nav a:hover{ text-decoration:underline; opacity:1 }

    /* ===== Page container ===== */
    .container{max-width:var(--maxw); margin:22px auto; padding:0 16px 60px}
    h1{font-size:22px; text-align:center; margin:6px 0 18px}
    h2{margin:0 0 12px}

    /* ===== Cards & toolbar ===== */
    .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 8px 24px rgba(0,0,0,0.04)}
    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px}
    .left-tools{display:flex; gap:10px; align-items:center}
    .btn{border:0; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; color:var(--accent); background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.danger{background:#f95c5c; color:#fff}
    .note{color:var(--muted); font-size:13px}

    /* ===== Table ===== */
    .table-wrap{overflow:auto; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:var(--card); padding:10px}
    table.att{width:100%; border-collapse:collapse; min-width:1100px}
    table.att th, table.att td{padding:10px 8px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:center; font-size:14px; vertical-align:middle}
    table.att thead th{background:var(--head); color:#fff; position:sticky; top:0; z-index:5; font-size:13px; padding:12px 8px}
    .nameCol{text-align:left; padding-left:14px}
    tr.green{background:var(--good)}
    tr.yellow{background:var(--warn)}
    tr.red{background:var(--bad)}

    /* checkbox styling */
    .chk{appearance:none; -webkit-appearance:none; width:18px; height:18px; border-radius:6px; border:2px solid #ddd; display:inline-block; position:relative; cursor:pointer; background:#fff}
    .chk:checked{background:var(--tick); border-color:var(--tick)}
    .chk:checked::after{
      content: '✓';
      position:absolute;
      left:3px;
      top:-1px;
      color:#4a2e01;
      font-weight:800;
      font-size:12px;
    }

    .meta{font-weight:700}
    .msg{text-align:left; font-weight:700; padding:10px}

    /* row hover highlight (class applied by JS) */
    .highlight-hover{outline:2px solid rgba(0,0,0,0.03);}

    /* excellent animation */
    .excellent{ animation: pulse 1s ease-in-out infinite alternate }
    @keyframes pulse{ from{box-shadow:0 0 0 0 rgba(34,170,110,0.12); transform:translateY(0)} to{box-shadow:0 10px 40px rgba(34,170,110,0.06); transform:translateY(-3px)} }

    /* ADD form */
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    input[type="text"], input[type="email"], input[type="file"], select, textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #ddd}
    .form-actions{display:flex; gap:10px; align-items:center; margin-top:8px}
    .muted{color:var(--muted)}

    /* report area */
    .cards{display:flex; gap:14px; flex-wrap:wrap; margin-bottom:18px}
    .stat{background:#fff; border-radius:8px; padding:18px; min-width:160px; box-shadow:0 6px 18px rgba(0,0,0,0.04); text-align:center}
    .stat strong{display:block; font-size:20px; margin-bottom:6px}
    .chart-wrap{background:#fff; padding:14px; border-radius:8px}

    /* small helpers */
    .flex{display:flex; gap:10px; align-items:center}
    .right{margin-left:auto}
    .small{font-size:13px;color:var(--muted)}
    .badge{background:var(--accent-2); color:#fff; padding:6px 8px; border-radius:8px; font-weight:700}

    /* responsive tweaks */
    @media (max-width:900px){ table.att{min-width:900px} }
    @media (max-width:700px){ .form-grid{grid-template-columns:1fr} .nav{padding:0 8px} .nav a{font-size:14px} .container{padding:0 10px} }
  </style>
</head>
<body>

  <!-- ===== header / nav ===== -->
  <header>
    <nav class="nav" role="navigation" aria-label="Main">
      <div class="brand">
        <img src="/mnt/data/image.png" alt="logo" onerror="this.style.display='none'">
        Attendance System
      </div>

      <div class="spacer"></div>

      <a href="#" class="nav-link" data-target="home">Home</a>
      <a href="#" class="nav-link" data-target="attendance">Attendance</a>
      <a href="#" class="nav-link" data-target="add">Add Student</a>
      <a href="#" class="nav-link" data-target="reports">Reports</a>

      <!-- Role selector to preview pages for different roles -->
      <select id="roleSelector" title="Switch role (preview)">
        <option value="professor">Professor</option>
        <option value="student">Student</option>
        <option value="administrator">Administrator</option>
      </select>

      <a href="#" id="logoutBtn" onclick="alert('Logged out')">Logout</a>
    </nav>
  </header>

  <!-- ===== main content container ===== -->
  <main class="container">

    <h1>Attendance System — Multi-Role Prototype</h1>

    <!-- Home page -->
    <section id="home" class="card active-section">
      <h2>Welcome</h2>
      <p class="muted">This prototype implements the frontend deliverables from the assignment: Professor, Student and Admin pages. Use the role selector to preview each role.</p>
      <div style="margin-top:12px" class="flex">
        <div class="card" style="flex:1">
          <h3>Quick actions</h3>
          <div class="flex" style="margin-top:8px">
            <button id="seedBtnTop" class="btn">Seed demo data</button>
            <button id="clearBtnTop" class="btn danger">Clear all</button>
            <button id="importExample" class="btn">Import CSV</button>
            <div class="small">Data stored in browser localStorage for prototype.</div>
          </div>
        </div>

        <div class="card" style="min-width:260px">
          <h3>Notes</h3>
          <ul style="margin:6px 0 0 18px;color:var(--muted)">
            <li>Frontend: jQuery + Chart.js (required).</li>
            <li>Backend: connect this to PHP + MariaDB for production (placeholders provided).</li>
            <li>Import/export uses Progress Excel compatible CSV format.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Attendance / Professor list -->
    <section id="attendance" class="card" style="margin-top:16px; display:none">
      <div class="toolbar">
        <div class="left-tools">
          <button id="profSessionsBtn" class="btn">Professor: Sessions</button>
          <button id="seedBtn" class="btn">Seed demo students</button>
          <button id="clearBtn" class="btn danger">Clear all</button>
          <button id="exportCSV" class="btn">Export CSV</button>
          <button id="highlightBtn" class="btn">Highlight Excellent</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>
        <div class="note">Click checkboxes to toggle presence/participation — all saved locally. Students can submit justifications (Student view).</div>
      </div>

      <div id="professorView">
        <h2>Professor — Sessions per Course</h2>
        <div class="card" style="margin-bottom:12px">
          <div class="flex">
            <div>
              <strong>Course:</strong> <span id="courseLabel">CS101</span>
            </div>
            <div class="right small">Sessions: <span id="sessionCount">6</span></div>
          </div>
          <div style="margin-top:10px" class="flex">
            <select id="sessionSelect"></select>
            <button id="openSession" class="btn primary">Open Session</button>
            <div class="small">Open a session to mark attendance</div>
          </div>
        </div>
      </div>

      <!-- table to mark attendance (used by professor session page & admin view) -->
      <div class="table-wrap" aria-live="polite">
        <table class="att" id="attendanceTable" aria-describedby="tableNote">
          <thead>
            <tr>
              <th class="nameCol" rowspan="2">Last Name</th>
              <th class="nameCol" rowspan="2">First Name</th>

              <th colspan="2">S1</th><th colspan="2">S2</th><th colspan="2">S3</th>
              <th colspan="2">S4</th><th colspan="2">S5</th><th colspan="2">S6</th>

              <th rowspan="2">Absences</th>
              <th rowspan="2">Participation</th>
              <th rowspan="2" style="min-width:240px">Message</th>
            </tr>

            <tr>
              <th>P</th><th>Pa</th><th>P</th><th>Pa</th><th>P</th><th>Pa</th>
              <th>P</th><th>Pa</th><th>P</th><th>Pa</th><th>P</th><th>Pa</th>
            </tr>
          </thead>

          <tbody id="tbody"></tbody>
        </table>
      </div>

      <p id="tableNote" class="muted" style="margin-top:8px">Tip: professor can toggle presence/participation; admin can import/export students.</p>
    </section>

    <!-- Add Student -->
    <section id="add" style="margin-top:18px; display:none">
      <div class="card">
        <h2>Add Student</h2>
        <form id="addForm" novalidate>
          <div class="form-field">
            <input id="stuId" type="text" placeholder="Student ID" aria-label="Student ID" />
          </div>

          <div class="form-grid">
            <div><input id="stuLast" type="text" placeholder="Last Name" aria-label="Last name" /></div>
            <div><input id="stuFirst" type="text" placeholder="First Name" aria-label="First name" /></div>
          </div>

          <div class="form-field">
            <input id="stuEmail" type="email" placeholder="Email" aria-label="Email" />
          </div>

          <div class="form-actions">
            <button class="btn primary" type="submit">Submit</button>
            <div id="confirm" style="color:green;font-weight:700;margin-left:6px"></div>
          </div>

          <div id="formErrors" class="muted" style="margin-top:8px"></div>
        </form>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" style="margin-top:18px; display:none">
      <div class="card">
        <h2>Attendance Report</h2>
        <div class="cards">
          <div class="stat"><strong id="statTotal">0</strong> Total Students</div>
          <div class="stat"><strong id="statPresent">0</strong> Students Marked Present</div>
          <div class="stat"><strong id="statParticip">0</strong> Students Participated</div>
        </div>

        <div class="chart-wrap">
          <canvas id="reportChart" style="width:100%;height:320px"></canvas>
        </div>
      </div>
    </section>

    <!-- Student view: attendance + submit justification -->
    <section id="student" style="margin-top:18px; display:none">
      <div class="card">
        <h2>Student — My Enrolled Courses</h2>
        <p class="muted">This view shows attendance status per course and lets the student submit absence justifications.</p>

        <div style="margin-top:12px">
          <div class="card" style="margin-bottom:10px">
            <strong>Course:</strong> CS101 — <span class="small">Teacher: Dr. B.</span>
            <div style="margin-top:10px">
              <button id="viewMyAttendance" class="btn">View Attendance</button>
            </div>
          </div>

          <div id="myAttendancePanel" style="display:none" class="card">
            <h3>Attendance (CS101)</h3>
            <div class="small">S1..S6</div>
            <div id="studentAttendanceList" style="margin-top:8px"></div>

            <div style="margin-top:12px">
              <h4>Submit Justification</h4>
              <form id="justForm">
                <select id="justSession"><option value="0">S1</option><option value="1">S2</option><option value="2">S3</option><option value="3">S4</option><option value="4">S5</option><option value="5">S6</option></select>
                <textarea id="justText" rows="3" placeholder="Describe your justification (short)"></textarea>
                <div class="form-actions">
                  <button class="btn primary" type="submit">Send Justification</button>
                  <div id="justConfirm" style="color:green;font-weight:700;margin-left:6px"></div>
                </div>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Admin pages -->
    <section id="admin" style="margin-top:18px; display:none">
      <div class="card">
        <h2>Administrator — Dashboard</h2>
        <div class="cards" style="margin-bottom:12px">
          <div class="stat"><strong id="admTotal">0</strong> Total Students</div>
          <div class="stat"><strong id="admReq">0</strong> Justification Requests</div>
          <div class="stat"><strong id="admExport">CSV Ready</strong></div>
        </div>

        <div style="margin-bottom:12px" class="flex">
          <div style="flex:1">
            <h3>Student List (Manage)</h3>
            <div class="table-wrap" style="max-height:300px; overflow:auto">
              <table class="att" id="adminTable">
                <thead><tr><th>ID</th><th>Last</th><th>First</th><th>Email</th><th>Actions</th></tr></thead>
                <tbody id="adminTbody"></tbody>
              </table>
            </div>
          </div>

          <div style="min-width:320px">
            <h3>Import / Export</h3>
            <input id="fileInput" type="file" accept=".csv" />
            <div class="form-actions">
              <button id="doImport" class="btn">Import CSV</button>
              <button id="doExport" class="btn primary">Export CSV</button>
            </div>

            <h4 style="margin-top:12px">Justification Requests</h4>
            <div id="justRequests" style="max-height:220px; overflow:auto; margin-top:8px"></div>
          </div>
        </div>

        <div class="chart-wrap" style="margin-top:12px">
          <canvas id="adminChart" style="width:100%;height:200px"></canvas>
        </div>
      </div>
    </section>

  </main>

  <script>
  /************************************************************************
   * Prototype data model & storage
   * - For production: replace storage functions to call PHP endpoints
   *   that persist to MariaDB. The UI here follows the assignment spec.
   ************************************************************************/
  const STORAGE_KEY = 'attendanceTP3_multi_v1_full';
  const JUST_KEY = 'attendanceTP3_justifications';

  function loadData(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e){ return []; } }
  function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  function loadJust(){ try { return JSON.parse(localStorage.getItem(JUST_KEY)) || []; } catch(e){ return []; } }
  function saveJust(j){ localStorage.setItem(JUST_KEY, JSON.stringify(j)); }

  // Demo dataset
  const demoStudents = [
    {id:'101', last:'Ahmed',  first:'Sara',    email:'sara@example.com', s:[1,0,1,0,1,0], p:[1,0,1,0,1,0]},
    {id:'102', last:'Yacine', first:'Ali',     email:'ali@example.com',  s:[1,1,1,1,1,1], p:[1,1,1,1,1,0]},
    {id:'103', last:'Houcine',first:'Rania',   email:'r@example.com',    s:[1,0,1,0,0,1], p:[0,1,0,1,0,0]},
    {id:'104', last:'Warda',  first:'Moufouki',email:'w@example.com',   s:[1,1,1,1,1,0], p:[1,1,1,0,1,0]},
    {id:'105', last:'Kamel',  first:'Khaled',  email:'k@example.com',    s:[0,0,0,0,0,0], p:[0,0,0,0,0,0]},
    {id:'106', last:'Farah',  first:'Lina',    email:'lina@example.com', s:[0,0,0,1,0,0], p:[0,0,0,1,0,0]},
  ];

  /************************************************************************
   * UI: render table used by professor & admin
   ************************************************************************/
  function renderTable(){
    const tbody = $('#tbody').empty();
    const data  = loadData();

    data.forEach((stu, idx) => {
      const tr = $('<tr>').attr('data-idx', idx);
      tr.append($('<td>').addClass('nameCol').text(stu.last));
      tr.append($('<td>').addClass('nameCol').text(stu.first));

      for(let i=0; i<6; i++){
        const pChk = $('<input>', {type:'checkbox', class:'chk present', 'aria-label':'presence'}).prop('checked', !!stu.s[i]).attr('data-i', i);
        const paChk = $('<input>', {type:'checkbox', class:'chk part', 'aria-label':'participation'}).prop('checked', !!stu.p[i]).attr('data-i', i);
        tr.append($('<td>').append(pChk));
        tr.append($('<td>').append(paChk));
      }

      tr.append($('<td>').addClass('meta absCount'));
      tr.append($('<td>').addClass('meta parCount'));
      tr.append($('<td>').addClass('msg'));

      tbody.append(tr);
      recalcRow(tr, stu);
    });

    attachHandlers();
    renderAdminTable();
  }

  function recalcRow($tr, stuOverride){
    const idx = parseInt($tr.attr('data-idx'));
    const data = loadData();
    const stu  = stuOverride || data[idx];
    if(!stu) return;

    const abs = stu.s.reduce((acc,v) => acc + (v?0:1), 0);
    const par = stu.p.reduce((acc,v) => acc + (v?1:0), 0);

    $tr.find('.absCount').text(abs + ' Abs');
    $tr.find('.parCount').text(par + ' Par');

    let msg = '';
    if(abs < 3) msg = 'Good attendance — Excellent participation';
    else if(abs <= 4) msg = 'Warning — attendance low';
    else msg = 'Excluded — too many absences';
    $tr.find('.msg').text(msg);

    $tr.removeClass('green yellow red');
    if(abs < 3) $tr.addClass('green');
    else if(abs <= 4) $tr.addClass('yellow');
    else $tr.addClass('red');
  }

  function attachHandlers(){
    $('.present').off('change').on('change', function(e){
      e.stopPropagation();
      const $tr = $(this).closest('tr');
      const idx = parseInt($tr.attr('data-idx'));
      const i   = parseInt($(this).attr('data-i'));
      const data = loadData();
      data[idx].s[i] = $(this).prop('checked') ? 1 : 0;
      saveData(data);
      recalcRow($tr, data[idx]);
    });

    $('.part').off('change').on('change', function(e){
      e.stopPropagation();
      const $tr = $(this).closest('tr');
      const idx = parseInt($tr.attr('data-idx'));
      const i   = parseInt($(this).attr('data-i'));
      const data = loadData();
      data[idx].p[i] = $(this).prop('checked') ? 1 : 0;
      saveData(data);
      recalcRow($tr, data[idx]);
    });

    $('#tbody tr').off('mouseenter mouseleave click')
      .on('mouseenter', function(){ $(this).addClass('highlight-hover'); })
      .on('mouseleave', function(){ $(this).removeClass('highlight-hover'); })
      .on('click', function(){
        const idx = parseInt($(this).attr('data-idx'));
        const s = loadData()[idx];
        const abs = s.s.reduce((a,v) => a + (v?0:1), 0);
        alert('Student: ' + s.last + ' ' + s.first + ' — Absences: ' + abs);
      });
  }

  /************************************************************************
   * Add student form validation & insert
   ************************************************************************/
  $('#addForm').on('submit', function(e){
    e.preventDefault();
    $('#confirm').text(''); $('#formErrors').text('');
    const id = $('#stuId').val().trim();
    const last = $('#stuLast').val().trim();
    const first = $('#stuFirst').val().trim();
    const email = $('#stuEmail').val().trim();
    let ok = true;
    if(!/^\d+$/.test(id)){ $('#formErrors').text('Student ID must be numbers only'); ok=false; }
    if(!/^[A-Za-zÀ-ÿ\-\s]+$/.test(last)){ $('#formErrors').text('Last name must contain letters only'); ok=false; }
    if(!/^[A-Za-zÀ-ÿ\-\s]+$/.test(first)){ $('#formErrors').text('First name must contain letters only'); ok=false; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ $('#formErrors').text('Invalid email'); ok=false; }
    if(!ok) return;

    const data = loadData();
    // prevent duplicate id
    if(data.some(s=>s.id===id)){ $('#formErrors').text('Student ID already exists'); return; }

    data.push({id, last, first, email, s:[0,0,0,0,0,0], p:[0,0,0,0,0,0]});
    saveData(data);
    renderTable();
    $('#confirm').text('Student added successfully!');
    setTimeout(()=>$('#confirm').text(''), 3000);
    $('#stuId,#stuLast,#stuFirst,#stuEmail').val('');
    showSection('attendance');
  });

  /************************************************************************
   * Reports (chart)
   ************************************************************************/
  let chartInstance = null;
  function showReport(){
    const data = loadData();
    const total = data.length;
    const presentCount = data.reduce((acc,s) => acc + (s.s.some(v=>v===1)?1:0), 0);
    const participCount = data.reduce((acc,s) => acc + (s.p.some(v=>v===1)?1:0), 0);

    $('#statTotal').text(total);
    $('#statPresent').text(presentCount);
    $('#statParticip').text(participCount);

    const ctx = document.getElementById('reportChart').getContext('2d');
    const chartData = {
      labels: ['Total','Present (≥1)','Participated (≥1)'],
      datasets: [{ data:[total,presentCount,participCount], backgroundColor:['#9a5b58','#0bb37d','#02b5d7'] }]
    };

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ display:false } } }
    });
  }

  /************************************************************************
   * Admin: render admin table, import/export CSV, justification requests
   ************************************************************************/
  function renderAdminTable(){
    const data = loadData();
    $('#adminTbody').empty();
    data.forEach((s, idx) => {
      const tr = $('<tr>');
      tr.append($('<td>').text(s.id));
      tr.append($('<td>').text(s.last));
      tr.append($('<td>').text(s.first));
      tr.append($('<td>').text(s.email));
      const actions = $('<td>');
      const del = $('<button class="btn danger small">Delete</button>').on('click', ()=>{ if(confirm('Delete student?')) { data.splice(idx,1); saveData(data); renderTable(); }});
      const edit = $('<button class="btn small">Edit</button>').on('click', ()=>{ const newLast = prompt('New last name', s.last); if(newLast){ s.last=newLast; saveData(data); renderTable(); }});
      actions.append(edit).append(' ').append(del);
      tr.append(actions);
      $('#adminTbody').append(tr);
    });

    refreshAdminStats();
    renderJustRequests();
  }

  function refreshAdminStats(){
    const data = loadData(), j = loadJust();
    $('#admTotal').text(data.length);
    $('#admReq').text(j.length);
  }

  // Create admin chart
  let adminChart = null;
  function renderAdminChart(){
    const data = loadData();
    const labels = data.map(d => d.last + ' ' + d.first);
    const absCounts = data.map(d => d.s.reduce((a,v)=>a + (v?0:1),0));
    const ctx = document.getElementById('adminChart').getContext('2d');
    if(adminChart) adminChart.destroy();
    adminChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Absences', data:absCounts }]},
      options:{ responsive:true, maintainAspectRatio:false }
    });
  }

  // Justification requests UI for admin
  function renderJustRequests(){
    const j = loadJust(), container = $('#justRequests').empty();
    if(!j.length) container.append($('<div class="small muted">No requests</div>'));
    j.forEach((r, idx) => {
      const card = $('<div>').addClass('card').css({'margin-bottom':'8px','padding':'8px'});
      card.append($('<div>').html('<strong>'+r.studentName+'</strong> — Session S'+(r.session+1)));
      card.append($('<div class="small">').text(r.text));
      const actions = $('<div class="form-actions">');
      const approve = $('<button class="btn small">Approve</button>').on('click', ()=>{ // mark presence on that session
        const data = loadData();
        const st = data.find(s => s.id === r.studentId);
        if(st){ st.s[r.session] = 1; saveData(data); renderTable(); }
        j.splice(idx,1); saveJust(j); renderJustRequests(); renderAdminTable();
      });
      const reject = $('<button class="btn danger small">Reject</button>').on('click', ()=>{ j.splice(idx,1); saveJust(j); renderJustRequests(); refreshAdminStats(); });
      actions.append(approve).append(reject);
      card.append(actions);
      container.append(card);
    });
    refreshAdminStats();
    renderAdminChart();
  }

  /************************************************************************
   * CSV import/export (simple, Progress Excel compatible structure):
   * Format: id,last,first,email,s1,s2,s3,s4,s5,s6,p1..p6
   ************************************************************************/
  function exportCSV(){
    const data = loadData();
    const header = ['id','last','first','email','s1','s2','s3','s4','s5','s6','p1','p2','p3','p4','p5','p6'];
    const rows = data.map(s => {
      const row = [s.id,s.last,s.first,s.email].concat(s.s,s.p);
      return row.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(',');
    });
    const csv = [header.join(',')].concat(rows).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'students_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // Import from file input
  $('#doImport').on('click', function(){
    const f = $('#fileInput')[0].files[0];
    if(!f){ alert('Select a CSV file first'); return; }
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const txt = e.target.result;
        const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        const header = lines.shift().split(',').map(h => h.replace(/"/g,'').trim().toLowerCase());
        const expected = ['id','last','first','email'];
        const newData = [];
        lines.forEach(line => {
          // quick CSV split (doesn't handle complicated quoted fields but suffices for prototype)
          const cols = line.split(',').map(c=>c.replace(/^"|"$/g,'').trim());
          if(cols.length < 16) return;
          const id = cols[0], last = cols[1], first = cols[2], email = cols[3];
          const s = cols.slice(4,10).map(v=>parseInt(v) || 0);
          const p = cols.slice(10,16).map(v=>parseInt(v) || 0);
          newData.push({id,last,first,email,s,p});
        });
        if(newData.length) { saveData(newData); renderTable(); alert('Import successful: ' + newData.length + ' students'); }
        else alert('No valid rows found');
      }catch(err){ alert('Import failed: ' + err.message); }
    };
    reader.readAsText(f);
  });

  $('#doExport').on('click', exportCSV);
  $('#exportCSV').on('click', exportCSV);

  /************************************************************************
   * Role & navigation handling
   ************************************************************************/
  function showSection(name){
    // hide all
    $('section').hide();
    if(name==='home') $('#home').show();
    else if(name==='attendance') $('#attendance').show();
    else if(name==='add') $('#add').show();
    else if(name==='reports') { showReport(); $('#reports').show(); }
    else if(name==='student') $('#student').show();
    else if(name==='admin') { $('#admin').show(); renderAdminTable(); renderAdminChart(); }
    window.scrollTo({top:0,behavior:'smooth'});
  }

  $('.nav-link').on('click', function(e){
    e.preventDefault();
    const target = $(this).data('target');
    showSection(target);
  });

  // Role selector: switches to role-specific default landing page
  $('#roleSelector').on('change', function(){
    const r = $(this).val();
    if(r==='professor'){ showSection('attendance'); }
    else if(r==='student'){ showSection('student'); }
    else if(r==='administrator'){ showSection('admin'); }
  });

  $('#showReportBtn').on('click', function(){ showReport(); showSection('reports'); });

  /************************************************************************
   * Student view: show own attendance and submit justification
   ************************************************************************/
  $('#viewMyAttendance').on('click', function(){
    const data = loadData();
    // for prototype, use the first student as "logged-in" student
    const student = data[0];
    if(!student){ alert('No student data — seed demo first'); return; }
    const panel = $('#myAttendancePanel').show();
    const list = $('#studentAttendanceList').empty();
    student.s.forEach((v, i) => {
      const line = $('<div>').text('S'+(i+1)+': ' + (v ? 'Present' : 'Absent') + ' — Participation: ' + (student.p[i] ? 'Yes' : 'No'));
      list.append(line);
    });
    // set default student in justification form (hidden mapping)
    $('#justForm').data('studentId', student.id);
  });

  $('#justForm').on('submit', function(e){
    e.preventDefault();
    const studentId = $(this).data('studentId');
    const session = parseInt($('#justSession').val());
    const text = $('#justText').val().trim();
    if(!text){ $('#justConfirm').text('Please write a justification'); setTimeout(()=>$('#justConfirm').text(''),2000); return; }
    const data = loadData();
    const st = data.find(s=>s.id===studentId);
    const j = loadJust();
    j.push({ studentId, studentName: (st ? st.last + ' ' + st.first : studentId), session, text, created: Date.now() });
    saveJust(j);
    $('#justConfirm').text('Justification sent');
    setTimeout(()=>$('#justConfirm').text(''),2500);
    $('#justText').val('');
    renderJustRequests();
  });

  /************************************************************************
   * Highlight excellent & reset
   ************************************************************************/
  $('#highlightBtn').on('click', function(){
    const data = loadData();
    $('#tbody tr').each(function(){
      const idx = parseInt($(this).attr('data-idx'));
      const s = data[idx];
      const abs = s.s.reduce((a,v)=>a + (v?0:1),0);
      if(abs < 3) $(this).addClass('excellent'); else $(this).removeClass('excellent');
    });
  });

  $('#resetBtn').on('click', function(){
    $('#tbody tr').removeClass('excellent highlight-hover');
    renderTable();
  });

  /************************************************************************
   * Seed / clear
   ************************************************************************/
  $('#seedBtn, #seedBtnTop').on('click', function(){ saveData(demoStudents); renderTable(); $('#confirm').text('Demo students seeded.'); setTimeout(()=>$('#confirm').text(''), 2200); });
  $('#clearBtn, #clearBtnTop').on('click', function(){ if(!confirm('Clear all saved students?')) return; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(JUST_KEY); renderTable(); renderAdminTable(); });

  /************************************************************************
   * Utility: admin opens a session number to mark
   ************************************************************************/
  function populateSessionSelect(){
    $('#sessionSelect').empty();
    for(let i=0;i<6;i++) $('#sessionSelect').append($('<option>').attr('value',i).text('Session S'+(i+1)));
    $('#sessionCount').text(6);
  }
  $('#openSession').on('click', function(){
    const sIdx = parseInt($('#sessionSelect').val());
    // highlight the session column visually (simple: scroll into view)
    alert('Opened Session S' + (sIdx+1) + ' — toggle presence/participation in the table');
  });

  /************************************************************************
   * Export / import helper: small example CSV creation
   ************************************************************************/
  $('#importExample').on('click', function(){
    // create a sample CSV and trigger download to show format
    const header = ['id','last','first','email','s1','s2','s3','s4','s5','s6','p1','p2','p3','p4','p5','p6'];
    const sample = ['201','Bend','Omar','omar@example.com','1','1','0','1','0','1','0','1','0','1','0','1'];
    const csv = [header.join(','), sample.join(',')].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='sample_import.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  /************************************************************************
   * Init
   ************************************************************************/
  $(function(){
    if(!localStorage.getItem(STORAGE_KEY)) saveData(demoStudents);
    renderTable();
    populateSessionSelect();
    showSection('home');
    // default role = professor
    $('#roleSelector').val('professor');
  });
  </script>
</body>
</html>

